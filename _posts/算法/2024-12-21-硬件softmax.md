---
layout: post
title: 硬件softmax
date: 2024-12-21 11:29 +0800
categories: [项目学习, 算法]
tags: []
math: true
img_path: /assets/img/learn/
---

[硬件友好的高效softmax函数实现调研与分析 - 知乎](https://zhuanlan.zhihu.com/p/577554331)
[Flash Attention中softmax分块计算详解 - 知乎](https://zhuanlan.zhihu.com/p/683191121)
## paper1：A High-Speed and Low-Complexity Architecture for Softmax Function in Deep Learning

$$
\begin{align}
s_i&=\dfrac{e^{x_i}}{\sum_{j=1}^N e^{x_j}} \\
&=exp(ln(\dfrac{e^{x_i}}{\sum_{j=1}^N e^{x_j}})) \\
&=exp(x_i-ln(\sum_{j=1}^N e^{x_j}))\\
&=exp(x_i-ln(F))
\end{align}
$$

$$lnF=ln2*\log_{2}^{F}$$

$$
\begin{align}
e^{x_i}&=2^{x_i\log_{2}^{e}}=2^{u_i+v_i}\\
&=2^{v_i} << u_i  (u_i>0)\\
&=2^{v_i} >> -u_i (u_i<=0)\\
\end{align}
$$


对$x_i*\log_{2}^{e}$可以进行这样的优化：

$\log_{2}^{e}=1.0111_2=1+0.1_2-0.0001_2$，所以可以看作$A+A>>1-A>>4$

对$lnF$而言，存在一个$k \in [1, 2)$，满足$F=2^wk$，所以只要找出F中，从左到右第一个1的位置的数，记作index，$w+index=F.getwidth-1$，k是F移位后的结果。

$lnF=ln2(w+\log_{2}^{k})=ln2(w+k-1)$，LOD的输出是w，k=F>>w

$ln2=0.1011_2=0.1+0.01-0.00001$，所以看作B>>1+B>>2-B>>5

<font color="#e5b9b7">总结流程：</font> 
- 串行输入$x_i$，存下来。得出$u_i,v_i$，同时不断累加获得F
- 通过F经过LOD处理，得出w,k
- 取出$x_i$，对$x_i-ln2*(w+k-1)$处理获得$u',v'$，得出$s_i$

注：这里的x是原始$x-x_{max}$

现在的问题就是得先等x都传输完了，才能算出w,k，然后又得慢慢取出x，算si。效率太低了



## 









---
>这个文章好像是假的，我复现出来的结果不对
{: .prompt-error}
>本文首先对Softmax函数计算进行优化，采用稀疏化策略，只选择输出有效值进行指数计算和存储，以降低计算冗余和存储需求； 其次通过动态移位更新最大值的方式，将最大值求取隐藏在流水线中，以提高计算效率。另外，依据 Softmax精度需求，指数及除法计算单元可配置成不同的设计方案，通过改进分段线性拟合算法，可 实现通用非线性函数中的指数、除法及S型函数等计算操作，缩小硬件资源开销。
{: .prompt-tip}

$$e^{x_i}=2^{x_i\log_{2}^{e}}=2^{u_i+v_i}$$

$$
\begin{align}
s_i&=\dfrac{e^{x_i}}{\sum_{j=1}^N e^{x_j}} \\
&=\dfrac{2^{u_i+v_i-max}}{\sum_{j=1}^N 2^{u_i+v_i-max}} \\
&= \dfrac{2^{v_i}2^{-(max-u_i)}}{sum} \\
(_LOD)&=\dfrac{f_i2^{-q_i}}{F2^Q}
\end{align}
$$

![sum]({{ page.img_path }}sum.png){: width="972" height="589" }
![max_op]({{ page.img_path }}max_op.png){: width="972" height="589" }
![softmax_arch]({{ page.img_path }}softmax_arch.png){: width="972" height="589" }

上面讲解了如何算出sum来，然后根据sum，设计一个LOD，来推断出一个$F \in [1, 2)$以及Q
,需要存储输入的$u_i和2^{v_i}(即f_i)$

硬件上：



